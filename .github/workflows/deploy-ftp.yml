name: Deploy to FTP Server

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Subdomain (e.g., subdomain.shifrastudio.com.ar)'
        required: true
        type: string
      server_dir:
        description: 'FTP directory (e.g., /public_html/subdomain/)'
        required: true
        type: string
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - production
          - staging
          - preview

jobs:
  deploy:
    name: Build and Deploy to FTP
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Generate version file
        run: |
          echo "{\"version\": \"$(date +%s)\", \"buildDate\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"commit\": \"${{ github.sha }}\"}" > dist/version.json
          echo "âœ… Version file generated: $(cat dist/version.json)"

      - name: Determine deployment config
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual deployment - usar inputs
            SERVER_DIR="${{ github.event.inputs.server_dir }}"
            echo "subdomain=${{ github.event.inputs.subdomain }}" >> $GITHUB_OUTPUT
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            # Auto deployment - usar mapeo por rama
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              SERVER_DIR="${{ secrets.FTP_SERVER_DIR_PRODUCTION }}"
              echo "subdomain=${{ secrets.SUBDOMAIN_PRODUCTION }}" >> $GITHUB_OUTPUT
              echo "environment=production" >> $GITHUB_OUTPUT
            elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
              SERVER_DIR="${{ secrets.FTP_SERVER_DIR_STAGING }}"
              echo "subdomain=${{ secrets.SUBDOMAIN_STAGING }}" >> $GITHUB_OUTPUT
              echo "environment=staging" >> $GITHUB_OUTPUT
            else
              # Feature branches - usar preview
              BRANCH_NAME="${{ github.ref_name }}"
              SERVER_DIR="/public_html/preview/${BRANCH_NAME}/"
              echo "subdomain=preview-${BRANCH_NAME}.shifrastudio.com.ar" >> $GITHUB_OUTPUT
              echo "environment=preview" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Normalizar server_dir: asegurar que termine con /
          if [ -n "${SERVER_DIR}" ] && [ "${SERVER_DIR: -1}" != "/" ]; then
            SERVER_DIR="${SERVER_DIR}/"
          fi
          
          echo "server_dir=${SERVER_DIR}" >> $GITHUB_OUTPUT
          
          echo "ðŸŒ Environment: $(echo ${{ steps.config.outputs.environment }})"
          echo "ðŸŒ Subdomain: $(echo ${{ steps.config.outputs.subdomain }})"
          echo "ðŸ“ Directory: ${SERVER_DIR}"

      - name: Get FTP credentials
        id: ftp
        run: |
          ENV="${{ steps.config.outputs.environment }}"
          
          # Usar secrets genÃ©ricos (recomendado) o especÃ­ficos por ambiente
          if [ "${{ secrets.FTP_SERVER }}" != "" ]; then
            # Si hay secret genÃ©rico, usarlo
            echo "server=${{ secrets.FTP_SERVER }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.FTP_USERNAME }}" >> $GITHUB_OUTPUT
            echo "password=${{ secrets.FTP_PASSWORD }}" >> $GITHUB_OUTPUT
          elif [ "${ENV}" == "production" ]; then
            # Secrets especÃ­ficos para producciÃ³n
            echo "server=${{ secrets.FTP_SERVER_PRODUCTION }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.FTP_USERNAME_PRODUCTION }}" >> $GITHUB_OUTPUT
            echo "password=${{ secrets.FTP_PASSWORD_PRODUCTION }}" >> $GITHUB_OUTPUT
          elif [ "${ENV}" == "staging" ]; then
            # Secrets especÃ­ficos para staging
            echo "server=${{ secrets.FTP_SERVER_STAGING }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.FTP_USERNAME_STAGING }}" >> $GITHUB_OUTPUT
            echo "password=${{ secrets.FTP_PASSWORD_STAGING }}" >> $GITHUB_OUTPUT
          else
            # Para preview, usar secrets genÃ©ricos o staging
            echo "server=${{ secrets.FTP_SERVER_STAGING }}" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.FTP_USERNAME_STAGING }}" >> $GITHUB_OUTPUT
            echo "password=${{ secrets.FTP_PASSWORD_STAGING }}" >> $GITHUB_OUTPUT
          fi

      - name: Verify FTP Secrets
        run: |
          SERVER_TEST="${{ steps.ftp.outputs.server }}"
          USERNAME_TEST="${{ steps.ftp.outputs.username }}"
          PASSWORD_TEST="${{ steps.ftp.outputs.password }}"
          
          if [ -z "${SERVER_TEST}" ]; then
            echo "âŒ Error: FTP_SERVER secret is not configured"
            exit 1
          fi
          
          if [ -z "${USERNAME_TEST}" ]; then
            echo "âŒ Error: FTP_USERNAME secret is not configured"
            exit 1
          fi
          
          if [ -z "${PASSWORD_TEST}" ]; then
            echo "âŒ Error: FTP_PASSWORD secret is not configured"
            exit 1
          fi
          
          echo "âœ… All FTP secrets are configured"

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ steps.ftp.outputs.server }}
          username: ${{ steps.ftp.outputs.username }}
          password: ${{ steps.ftp.outputs.password }}
          port: 9021
          protocol: ftps
          local-dir: ./dist/
          server-dir: ${{ steps.config.outputs.server_dir }}
          timeout: 600000
          log-level: verbose
          dangerous-clean-slate: false
          dry-run: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/Thumbs.db

      - name: Deployment Summary
        run: |
          {
            echo "## ðŸš€ Deployment Complete"
            echo ""
            echo "- **Environment:** ${{ steps.config.outputs.environment }}"
            echo "- **Subdomain:** ${{ steps.config.outputs.subdomain }}"
            echo "- **Branch:** ${{ github.ref_name }}"
            echo "- **Server Directory:** ${{ steps.config.outputs.server_dir }}"
            echo "- **Commit:** ${{ github.sha }}"
            echo "- **Deployed by:** ${{ github.actor }}"
          } >> $GITHUB_STEP_SUMMARY